<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh" xml:lang="zh">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link rel="stylesheet" type="text/css" href="learn-vi.css" />
	<title>VIM学习笔记  脚本(Script)</title>
</head>
<body>
	<p>使用脚本语言，可以更灵活地定制编辑器。</p>
	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">变量</p>
	<p>使用以下命令，可以为变量赋值：</p>
	<p style="text-indent:2em"><code class="inset">:let {variable}={expression}</code></p>
	<p>Vim中的变量名可以包含字符、数字和下划线，但必须以字符或是下划线开头。</p>
	<p>例如使用以下命令，定义变量line_size：</p>
	<p style="text-indent:2em"><code class="inset">:let line_size=30</code></p>
	<p>使用:echo命令，可以查看变量的内容：</p>
	<p style="text-indent:2em"><code class="inset">:echo "line_size is"line_size</code></p>
	<p>命令执行以后，Vim将会在屏幕底部显示如下内容：</p>
	<p><code class="msg">line_size is 30</code></p>
	<p>Vim使用特殊的前缀来指明不同的变量类型：</p>
	<table summary="Commands" border="2" frame="hsides" rules="all" cellspacing="0" cellpadding="3">
		<tr><th>变量名</th><th>用途</th></tr>
		<tr><td>大写字母,数字,下划线</td><td>可以存放在viminfo文件中的变量（如果viminfo选项中含有!标记）</td></tr>
		<tr><td>大写字母开头</td><td>变量可以由:makesession命令保存</td></tr>
		<tr><td>小写字母,数字,下划线</td><td>不会存在任何保存文件中的变量</td></tr>
		<tr><td>$environment</td><td>环境变量</td></tr>
		<tr><td>@register</td><td>文本寄存器</td></tr>
		<tr><td>&amp;option</td><td>选项名字</td></tr>
		<tr><td>b:name</td><td>当前缓冲区的变量</td></tr>
		<tr><td>w:name</td><td>当前窗口的变量</td></tr>
		<tr><td>g:name</td><td>全局变量（用于函数内部表明全局变量）</td></tr>
		<tr><td>a:name</td><td>函数参数</td></tr>
		<tr><td>v:name</td>Vim预定义内部变量<td></td></tr>
		<tr><td>l:name</td><td>当前函数的变量</td></tr>
		<tr><td>s:name</td><td>使用:source载入的脚本</td></tr>
		<tr><td>t:name</td><td>当前标签页的变量</td></tr>
	</table>
	<p>使用以下命令，可以定义环境变量$PAGE包含用于查看的命令：</p>
	<p style="text-indent:2em"><code class="inset">:let $PAGER="/usr/local/bin/less"</code></p>
	<p>使用以下命令，可以显示上一次查找的模式：</p>
	<p style="text-indent:2em"><code class="inset">:echo "Last search was"@/</code></p>
	<p>使用以下任一命令，都可以设置缩进选项：</p>
	<p style="text-indent:2em"><code class="inset">:let &amp;autoindent=1</code></p>
	<p style="text-indent:2em"><code class="inset">:set autoindent</code></p>
	<p>使用以下命令，可以指定当前缓冲区的语法高亮显示：</p>
	<p style="text-indent:2em"><code class="inset">:let b:current_syntax=c</code></p>
	
	<p>Vim使用以下内部变量(v:name)存储相关信息：</p>
	<table summary="Commands" border="2" frame="hsides" rules="all" cellspacing="0" cellpadding="3">
		<tr><th>变量</th><th>用途</th></tr>
		<tr><td>v:count</td><td>上一次常规模式命令所指定的数量</td></tr>
		<tr><td>v:count1</td><td>与v:count相类似，所不同的是如果没有指定数量则默认值为1</td></tr>
		<tr><td>v:errmsg</td><td>上一次的错误信息</td></tr>
		<tr><td>v:warningmsg</td><td>上一次的警告信息</td></tr>
		<tr><td>v:statusmsg</td><td>上一次的状态信息</td></tr>
		<tr><td>v:shell_error</td><td>上一次Shell命令的结果。如果为0，则命令正常执行；若为非0，则命令失败</td></tr>
		<tr><td>v:this_session</td><td>上一次装入或是保存的文件的命名</td></tr>
		<tr><td>v:version</td><td>Vim编辑器的版本号</td></tr>
	</table>
	<p><script src="https://gist.github.com/yyq123/3c1db548929b59aa00f87917f5de6d8c.js"></script></p>
	<p>如果要删除一个变量，那么可以使用以下命令：</p>
	<p style="text-indent:2em"><code class="inset">:unlet[!] {name}</code></p>
	<p>如果试图删除一个不存在的变量，那么Vi就会报错；而如果使用!标记，则不会显示错误信息。</p>

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">常量</p>
	<p>数字常量有以下三种：</p>
	<ul>
		<li>八进制（Octal Integer）：0123</li>
		<li>十进制（Simple Integer）：123</li>
		<li>十六进制（Hexadecimal）：0xAC</li>
	</ul>
	<p>Vim可以处理多种格式数字的计算：</p>
	<p style="text-indent:2em"><code class="inset">:echo 10 + 0x0A + 012</code></p>
	
	<p>字符常量有以下两种：</p>
	<ul>
		<li>简单字符串（Simple String）："string"</li>
		<li>精确字符串（Literal String）：'string'</li>
	</ul>
	<p>在双引号包围的字符串内，可以使用反斜线进行转义；而被单引号包围的字符串，则会被原样输出:</p>
	<table summary="Logical Operators" border="1" frame="box" rules="all" cellspacing="3" cellpadding="5">
		<tr><th>命令</th><th>输出</th></tr>
		<tr><td><code class="inset">:echo "\100"</code></td><td>@</td></tr>
		<tr><td><code class="inset">:echo '\100'</code></td><td>\100</td></tr>
	</table>

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">算术运算</p>
	<p>Vim可以使用以下算术运算符，进行表达式计算：</p>
	<table summary="Logical Operators" border="1" frame="box" rules="all" cellspacing="3" cellpadding="5">
		<tr><td>int+int</td><td>加</td></tr>
		<tr><td>int-int</td><td>减</td></tr>
		<tr><td>int*int</td><td>乘</td></tr>
		<tr><td>int/int</td><td>除</td></tr>
		<tr><td>int%int</td><td>取余</td></tr>
		<tr><td>-int</td><td>取负</td></tr>
	</table>

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">逻辑判断</p>
	<p>逻辑运算符可以作用于字符串和整数，Vim将自动在这两种数据类型之间进行转换。如果比较成功则返回1，否则返回0。</p>
	<table summary="Logical Operators" border="1" frame="box" rules="all" cellspacing="3" cellpadding="5">
		<tr><td>var == var</td><td>等于</td></tr>
		<tr><td>var != var</td><td>不等</td></tr>
		<tr><td>var <  var</td><td>小于</td></tr>
		<tr><td>var &gt;  var</td><td>大于</td></tr>
		<tr><td>var <= var</td><td>小于等于</td></tr>
		<tr><td>var &gt;= var</td><td>大于等于</td></tr>
	</table>
	<p>比较运算符可以进行字符串正则表达式的比较。例如将字符串"word"和表过式"\w*"比较，如果匹配则返回1。</p>
	<p style="text-indent:2em"><code class="inset">"word"=~"\w*"</code></p>
	<p>字符串的特殊比较包括：</p>
	<table summary="Logical Operators" border="1" frame="box" rules="all" cellspacing="3" cellpadding="5">
		<tr><td>string =~ regexp</td><td>匹配的正则表达式</td></tr>
		<tr><td>string !~ regexp</td><td>不匹配的正则表达式</td></tr>
		<tr><td>string ==? string</td><td>字符串相等,忽略大小写</td></tr>
		<tr><td>string ==# string</td><td>字符串相等,大小写敏感</td></tr>
		<tr><td>string !=? string</td><td>字符串不相等,忽略大小写</td></tr>
		<tr><td>string !=# string</td><td>字符串不相等,大小写敏感</td></tr>
		<tr><td>string &lt;?  string</td><td>小于,忽略大小写</td></tr>
		<tr><td>string &lt;#  string</td><td>小于,大小写必须敏感</td></tr>
		<tr><td>string &lt;=? string</td><td>小于等于,忽略大小写</td></tr>
		<tr><td>string &lt;=# string</td><td>小于等于,大小写敏感</td></tr>
		<tr><td>string &gt;?  string</td><td>大于,忽略大小写</td></tr>
		<tr><td>string &gt;#  string</td><td>大于,大小写敏感</td></tr>
		<tr><td>string &gt;=? string</td><td>大于等于,忽略大小写</td></tr>
		<tr><td>string &gt;=# string</td><td>大于等于,大小写敏感</td></tr>
	</table>
	<p>由此可见，每一个运算符有三种形式。基本形式(==)对应ignorecase选项；(==?)忽略大小写；(==#)则大小写敏感。</p>

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">文件名</p>
	<p>当我们输入文件名时，可以使用以下特殊符号：</p>
	<table summary="Logical Operators" border="1" frame="box" rules="all" cellspacing="3" cellpadding="5">
		<tr><td>%</td><td>当前文件名</td></tr>
		<tr><td>#</td><td>交换文件名（Alternate filename）</td></tr>
		<tr><td>&lt;cword&gt;</td><td>光标下的word</td></tr>
		<tr><td>&lt;cWORD&gt;</td><td>光标下的WORD</td></tr>
		<tr><td>&lt;cfile&gt;</td><td>光标下的文件名</td></tr>
		<tr><td>&lt;afile&gt;</td><td>当执行相关的自动命令(autocommand)正读入或是写入的文件名</td></tr>
		<tr><td>&lt;abuf&gt;</td><td>在一个自动命令中的当前缓冲区标号</td></tr>
		<tr><td>&lt;amatch&gt;</td><td>与&lt;abuf&gt;类似，但是在FileType或Syntax事件中并不是指代文件名，而是文件类型或语法名</td></tr>
		<tr><td>&lt;sfile&gt;</td><td>当前正用于:sourced的文件名</td></tr>
	</table>
	<p>我们可以使用以下修饰符来扩展以上特殊符号的意义。例如<em>:p</em>可以将文件名转换为包括路径的全名。例如光标下的文件名为<em>test.c</em>，<em>>&lt;cfile&gt;</em>是<em>test.c</em>，那么<em>&lt;cfile:p&gt;就是<em>/home/oualline/examples/test.c</em>
</p>
	<p>修饰符主要包括：</p>
	<table summary="Commands" border="2" frame="hsides" rules="all" cellspacing="0" cellpadding="3">
		<tr><td><code class="inset">:p</code></td>将文件名变成全路径文件名。如果使用多个修饰符，那么必须将此修饰符放置在最前面。<td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
		<tr><td><code class="inset"></code></td><td></td></tr>
	</table>
:~
将全路径名/home/oualline/examples/test.c变为用~标记的文件名为,如~oualline/examples/test.c
:.    如果可能将成为当前目录相关的目录
:h    文件名的头部.例如../path/test.c就会为../path
:t    文件名的尾部.例如../path/test.c就会为test.c
:r    无扩展名的文件名.例如../path/test就会成为test
:e    扩展名
:s?from?to?    将第一次出现的form字符串改变为to字符串
:gs?from?to?    将所有的字符串form改变为to字符串
我们可以来看一下这些修饰符是如何作用在文件名上的.首先我们要先创建一个文件,其内容为我们运行实验的文件名.我们将光标放在这个文件名上,使用下面的命令来设置修饰符:
:echo expand("<cword>:p")
我们可将这里的:p换成我们可以试验的任何修饰符.

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">:echo命令</p>
:echo的功能只是重复他的参数.例如:
:echo "Hello world"
Hello world
我们还可以用他来显示变量的值:
:let flag=1
:echo flag
1
:echon命令也只是重复他的参数,但是不会输出新行.例如:
:echo "aa" | echo "bb"
aa
bb
:echon "aa" | echon "bb"
aabb
(注:这里的|用来分隔同一行的两个命令)
我们可以使用:echohl命令来改变:echo的输出的指定高亮颜色组.例如:
:echohl ErroMsg
:echo "A mistake has been make"
:echohl None
一个好的程序习惯表明我们应该总是在我们的输出信息之后重设高亮显示为None.这样就不会影响其他的:echo命令了.
如果我们要查看所定义的高亮显示组,我们可以用下面的命令:
:highlight

<p>在echo命令中，可以使用以下转义符：</p>
<ul>
	<li><code class="inset">\n</code>&nbsp;Newline</li>
	<li><code class="inset">\r</code>&nbsp;Carriage return</li>
	<li><code class="inset">\t</code>&nbsp;Tab</li>
	<li><code class="inset">\123</code>&nbsp;八进制数字</li>
	<li><code class="inset">\x123</code>&nbsp;十六进制数字</li>
	<li><code class="inset">\u01fc34</code>&nbsp;Unicode</li>
	<li><code class="inset">\f</code>&nbsp;Form feed</li>
	<li><code class="inset">\e</code>&nbsp;Esc</li>
	<li><code class="inset">\b</code>&nbsp;Backspace</li>
	<li><code class="inset">\\</code>&nbsp;反斜线</li>
	<li><code class="inset"></code>&nbsp;</li>
</ul>
Besides these escape characters, you can always insert the Vim-specific key
acronyms like <CR> and <ESC> by prepending them with a backslash \<CR>. Even
the Vim-specific key shortcuts (like <C-W> for Ctrl-W) can be inserted by escaping them with a backslash.
	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">判断</p>
<p>if语句的一般形式如下</p>
<p><script src="https://gist.github.com/yyq123/37f94883a1073534ded1cba1ad1b0831.js"></script></p>
<p>只有条件(condition)为真时，if语句块内的语句才会被执行。</p>
<p>if语句还可以包含else的子句</p>
<p><script src="https://gist.github.com/yyq123/4745a7c937e2f50ea3cdf7a97b43d5dc.js"></script></p>
<p>满足条件(condition)时，if语句块内的语句将会被执行；而不满足条件(condition)时，则else语句块内的语句将会被执行。</p>
<p>if-else还可以进行多重判断</p>
<p><script src="https://gist.github.com/yyq123/1ef507645718969cab35add75ef04e90.js"></script></p>

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">循环</p>
	<p>while命令开始一个循环，并由endwhile命令结束。在条件为真是，循环中的代码将被重复执行。</p>
	<p><script src="https://gist.github.com/yyq123/f87f86115272d5a9a0ab24682d03d1cc.js"></script></p>
	<p>continue命令回到程序的顶部开始执行下一次循环；而break命令则立刻退出循环。</p>
	<p><script src="https://gist.github.com/yyq123/54235dab1797017f16ae38a654c0fe4a.js"></script></p>

    :execute命令:
:execute命令像正常的命令模式一样执行一参数:
:let  command = " echo 'Hello world!'"
:execute command
	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">函数</p>
	<p>Vim编辑器还允许我们定义自己的函数.函数定义的一般形式如下:</p>
	<p><script src="https://gist.github.com/yyq123/8ccf228e869fb644f395e1756095de3d.js"></script></p>
	<p><em>Name</em>，函数名称必须以大写字母开始，并且只可以包含字母、数字和下划线。</p>
	<p><em>arg1-argN</em>，调用函数时需要被赋值的参数。如果不需要任何参数，那么可以将括号()部分置空。最多可以定义20个参数。</p>
	<p><em>keyword</em>，range关键字定义一个范围函数，当在一个范围的行内运行这个程序时,变量a:firstline,a:lastline就会设置成为这个范围内的第一行和最后一行；abort关键字指示函数会在第一个错误时退出。</p>
	<p>下面我们来定义一个小函数,用这个函数来返回两个数中较小的一个</p>
	<p><script src="https://gist.github.com/yyq123/4c18997ffac9a857d6d0f0b452923df4.js"></script></p>
	<p>函数内部的变量（例如smaller）均为局部变量，除非使用了g:作为前缀。例如在函数外我们定义了变量var，那么在函数内部可以使用g:var来调用。前缀a:的变量均为函数参数。</p>
	<p>return语句用于返回结果并结束函数。return语句之后的所有代码都不会被执行。</p>
	<p>可以在表达式中调用函数：</p>
	<p style="text-indent:2em"><code class="inset">:let tiny = Min(10,20)</code></p>
	
我们还可以用:call命令用函数名来显示调用函数功能:
:[range]call {function}([parameters])
如果指定了[range]则每一行都要调用函数,除非这个函数是一特殊的range风格函数.
<p>如果我们尝试定义一个已经存在的函数，那么就会得到一个错误信息。我们可以使用!来强制替换之前定义的同名函数。</p>


<p>Vim允许在函数中使用&ldquo;...&rdquo;标识个数不定的参数。例如以下代码定义函数至少有2个参数，最多有20个参数：</p>
<p><script src="https://gist.github.com/yyq123/ff3e8bc64a9bcf9f3745602da5a9aba9.js"></script></p>
<p><em>argnum</em> 计数器，用于记录num1和num2之后的参数个数；</p>
<p><em>a:0</em> 变量，用于记录参数总个数；</p>
<p><em>a:{argnum}</em> 变量，用于访问每一个参数的值；</p>

<p>使用以下命令，可以列出所有用户定义的函数：</p>
<p style="text-indent:2em"><code class="inset">:function</code></p>
<p>使用以下命令，可以查看指定函数的代码：</p>
<p style="text-indent:2em"><code class="inset">:function {name}</code></p>
<p>使用以下命令，可以删除指定的函数：</p>
<p style="text-indent:2em"><code class="inset">:delfunction {name}</code></p>

<p>使用以下命令，可以查看关于函数的更多帮助信息：</p>
<p style="text-indent:2em"><code class="inset">:help function-list</code></p>

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">命令</p>
Vim编辑器允许我们定义自己的命令.我们可以像执行其他的命令模式的命令一样来执行我们自己定义的命令.要定义一个命令我们要使用:command命令,例如:
:command Delete_first :1delete
这样当我们执行命令:Delete_first Vim就会执行:1delete,从而删除第一行.
如果我们要列出用户定义的命令,我们可以用下面的命令:
:command
要删除用户定义的命令,我们可以用下面的命令:
:delcommand
例如:
:delcommand Delete_one
我们还可以用下面的命令来清除所有的用户定义的命令:
:comclear
用户定义的命令可以指定一系列的参数.参数的个数要由-nargs选项在命令行中指定.例如,Delete_one命令没有参数,我们可以像下面的样子来定义:
:command Delete_one -nargs=0 1delete
然而因为在默认的情况下-nargs=0,所以我们不需要指定他.
其他的-nargs选项值如下:
-nargs=0    没以参数
-nargs=1    1个参数
-nargs=*    任何个数的参数
-nargs=?    零个或是一个参数
-nargs=+    一个或是更多个参数
在命令的定义中,参数是由关键字<args>指定的.例如:
:command -nargs=+ Say :echo "<args>"
然后我们输入:
:Say Hello World
命令的执行结果为:
Hello World
一些命令是指定一个范围作为其参数.告诉Vim我们在定义这样的一个命令我们需要指定-range选项.选项的值如下:
-range    允许的范围,默认为当前行.
-range=%    允许的范围,默认为当前文件(while file)
-range=count    允许的范围,但是他只是一个单一的数字,默认下为count.
当我们指定了一个范围以后,我们就可以用关键字<line1>和<line2>得到这个范围的第一行和最后一行.
例如下面的命令定义了一个SaveIt命令,这个命令可以将指定范围的文件写入文件save_file:
:command -range=% SaveIt:<line1>,<line2> write! save_file
其他的一些选项和关键字如下:
-count=number
这个命令指定一个数量,默认为number.数量的结果保存在关键字<count>中.
-bang    我们可以使用!修饰符.如果指定了,!将会被存放在关键字<bang>中.
-register
我们可以指定一个寄存器,默认为未命名寄存器.寄存器的定义放在关键字<reg>中.
关键字<f-args>含有与关键字<args>相同的信息.所不同的只是函数的调用方式不同.例如:
:command -nargs=* DoIt :call AFunction(<f-args>)
:DoIt a b c 
执行下面的命令:
:call AFunction("a","b","c")
最后我们还有<lt>关键字,他包含字符<.

	<p style="font-weight:bold; border-bottom:1px solid lightgray; border-left:6px solid lightgray; padding:0 0 3px 5px">脚本文件架构</p>
	<p>文件头（Header）：脚本的描述，作者，版本，最近更新日期，授权方式等。以"开头为注释。</p>
	<p>脚本载入检查（Script-Loaded Check）：检查脚本是否已经被载入，如果已经载入，那么应该首先卸载，然后再执行后续功能；检查是否使用vi兼容模式。</p>
	<p style="text-indent:2em"><code class="inset"></code></p>
	<p><script src="https://gist.github.com/yyq123/6e11fad7cbc540f972cf5b0044302725.js"></script></p>
	<p><code class="inset">:help 'write-filetype-plugin'<br />
	:help 'write-compiler-plugin'<br />
	:help 'write-library-script'<br /></code></p>
	<table summary="Commands" border="2" frame="hsides" rules="all" cellspacing="0" cellpadding="3">
		<caption>命令小结</caption>
		<tr><td><code class="inset">:</code></td><td rowspan="2"></td></tr>
		<tr><td><code class="inset">:</code></td></tr>
		<tr><td><code class="inset">:</code></td><td></td></tr>
		<tr><td><code class="inset">:</code></td><td></td></tr>
		<tr><td><code class="inset">:</code></td><td></td></tr>
	</table>

	<p style="border-top:1px solid lightgray"><span style="float:right">Ver: 1.0</span><span>&lt;<a title="()" href="">上一篇</a>&nbsp;|<a title="笔记列表" href="http://yyq123.github.com/learn-vim/learn-vi-00-List.html">&nbsp;目录&nbsp;</a>|&nbsp;<a title="()" href="">下一篇</a>&gt;</span></p>
</body>
</html>

